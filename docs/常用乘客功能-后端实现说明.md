# ä¹˜å®¢ä¿¡æ¯ç®¡ç†åŠŸèƒ½ - åç«¯å®Œæ•´å®ç°è¯´æ˜

> **é¡¹ç›®æ ¹ç›®å½•**: `SEUAirline/`  
> **åç«¯é¡¹ç›®**: `seu-airline-backend/`

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜ä¹˜å®¢ä¿¡æ¯ç®¡ç†åŠŸèƒ½çš„åç«¯å®ç°ï¼ŒåŒ…æ‹¬æ•°æ®åº“è®¾è®¡ã€å®ä½“ç±»ã€æœåŠ¡å±‚ã€æ§åˆ¶å™¨ç­‰å®Œæ•´ä»£ç ã€‚

---

## ğŸ—„ï¸ ä¸€ã€æ•°æ®åº“è®¾è®¡

### 1.1 æ•°æ®åº“åˆå§‹åŒ–

**ä¹˜å®¢ä¿¡æ¯è¡¨å·²é›†æˆåˆ°ä¸»åˆå§‹åŒ–è„šæœ¬ä¸­ï¼Œæ— éœ€å•ç‹¬æ‰§è¡Œï¼**

æ•°æ®åº“è„šæœ¬ä½ç½®ï¼š
```text
seu-airline-backend/src/main/resources/init-database.sql
```

è¿™ä¸ªè„šæœ¬åŒ…å«ï¼š

- âœ… æ‰€æœ‰è¡¨ç»“æ„ï¼ˆåŒ…æ‹¬ `passengers` è¡¨ï¼‰
- âœ… åŸºç¡€æ•°æ®ï¼ˆç”¨æˆ·ã€èˆªç©ºå…¬å¸ã€æœºåœºã€èˆªç­ç­‰ï¼‰
- âœ… æµ‹è¯•æ•°æ®ï¼ˆåŒ…æ‹¬ä¹˜å®¢ä¿¡æ¯ï¼‰

### 1.2 æ‰§è¡Œæ•°æ®åº“è„šæœ¬

**Windows PowerShell å‘½ä»¤ï¼š**

```powershell
# å¯¼èˆªåˆ° SQL è„šæœ¬æ‰€åœ¨ç›®å½•
cd seu-airline-backend/src/main/resources

# æ‰§è¡Œå®Œæ•´åˆå§‹åŒ–è„šæœ¬ï¼ˆéœ€è¾“å…¥ MySQL root å¯†ç ï¼‰
Get-Content init-database.sql | mysql -u root -p seu_airline
```

**éªŒè¯è¡¨åˆ›å»ºæˆåŠŸï¼š**

```powershell
mysql -u root -p seu_airline -e "DESCRIBE passengers;"
```

### 1.3 è¡¨ç»“æ„è¯´æ˜

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | å¤‡æ³¨ |
|--------|------|------|------|
| `id` | BIGINT | ä¸»é”®ID | è‡ªå¢ |
| `user_id` | BIGINT | ç”¨æˆ·ID | å¤–é”®ï¼Œçº§è”åˆ é™¤ |
| `passenger_name` | VARCHAR(100) | ä¹˜å®¢å§“å | å¿…å¡« |
| `id_type` | VARCHAR(20) | è¯ä»¶ç±»å‹ | ID_CARD/PASSPORT/OTHER |
| `id_card` | VARCHAR(50) | è¯ä»¶å·ç  | å¿…å¡«ï¼Œæœ‰ç´¢å¼• |
| `phone` | VARCHAR(20) | è”ç³»ç”µè¯ | é€‰å¡« |
| `email` | VARCHAR(100) | é‚®ç®±åœ°å€ | é€‰å¡« |
| `passenger_type` | VARCHAR(20) | ä¹˜å®¢ç±»å‹ | ADULT/CHILD/INFANT |
| `is_default` | BOOLEAN | æ˜¯å¦é»˜è®¤ | é»˜è®¤ false |
| `created_at` | DATETIME | åˆ›å»ºæ—¶é—´ | è‡ªåŠ¨å¡«å…… |
| `updated_at` | DATETIME | æ›´æ–°æ—¶é—´ | è‡ªåŠ¨æ›´æ–° |

---

## ğŸ—ï¸ äºŒã€åç«¯ä»£ç ç»“æ„

### 2.1 å·²åˆ›å»ºçš„ç±»åˆ—è¡¨

```text
seu-airline-backend/src/main/java/com/seu/airline/
â”œâ”€â”€ entity/
â”‚   â””â”€â”€ Passenger.java                  // å®ä½“ç±»
â”œâ”€â”€ dto/
â”‚   â”œâ”€â”€ PassengerDTO.java              // è¿”å›æ•°æ®DTO
â”‚   â”œâ”€â”€ PassengerCreateRequest.java    // åˆ›å»ºè¯·æ±‚DTO
â”‚   â””â”€â”€ PassengerUpdateRequest.java    // æ›´æ–°è¯·æ±‚DTO
â”œâ”€â”€ repository/
â”‚   â””â”€â”€ PassengerRepository.java       // æ•°æ®è®¿é—®å±‚
â”œâ”€â”€ service/
â”‚   â””â”€â”€ PassengerService.java          // æœåŠ¡å±‚
â””â”€â”€ controller/
    â””â”€â”€ PassengerController.java       // æ§åˆ¶å™¨
```

---

## ğŸ“¦ ä¸‰ã€æ ¸å¿ƒç±»è¯´æ˜

### 3.1 Passenger.java - å®ä½“ç±»

**ä½ç½®ï¼š** `entity/Passenger.java`

**å…³é”®æ³¨è§£ï¼š**

- `@Entity` - JPA å®ä½“æ ‡è®°
- `@Table(name = "passengers")` - æ˜ å°„åˆ° passengers è¡¨
- `@EntityListeners(AuditingEntityListener.class)` - è‡ªåŠ¨å®¡è®¡ï¼ˆéœ€åœ¨é…ç½®ç±»å¯ç”¨ï¼‰
- `@CreatedDate` / `@LastModifiedDate` - è‡ªåŠ¨å¡«å……æ—¶é—´æˆ³

**å­—æ®µæ˜ å°„ï¼š**

- æ•°æ®åº“å­—æ®µä½¿ç”¨ snake_caseï¼ˆå¦‚ `passenger_name`ï¼‰
- Java å±æ€§ä½¿ç”¨ camelCaseï¼ˆå¦‚ `passengerName`ï¼‰
- é€šè¿‡ `@Column(name = "...")` æ˜ å°„

---

### 3.2 PassengerRepository.java - æ•°æ®è®¿é—®å±‚

**ä½ç½®ï¼š** `repository/PassengerRepository.java`

**æ ¸å¿ƒæ–¹æ³•ï¼š**

| æ–¹æ³•å | åŠŸèƒ½ | è¿”å›å€¼ |
|--------|------|--------|
| `findByUserIdOrderByIsDefaultDescCreatedAtDesc()` | æŸ¥è¯¢ç”¨æˆ·æ‰€æœ‰ä¹˜å®¢ï¼ˆé»˜è®¤åœ¨å‰ï¼‰ | List |
| `findByIdAndUserId()` | æŸ¥è¯¢æŒ‡å®šIDä¸”éªŒè¯æ‰€å±ç”¨æˆ· | Optional |
| `clearDefaultByUserId()` | å–æ¶ˆç”¨æˆ·æ‰€æœ‰ä¹˜å®¢çš„é»˜è®¤çŠ¶æ€ | void |
| `countByUserId()` | ç»Ÿè®¡ç”¨æˆ·ä¹˜å®¢æ•°é‡ | long |
| `existsByUserIdAndIdCard()` | æ£€æŸ¥è¯ä»¶å·æ˜¯å¦é‡å¤ | boolean |

---

### 3.3 PassengerService.java - æœåŠ¡å±‚

**ä½ç½®ï¼š** `service/PassengerService.java`

**æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼š**

1. **åˆ›å»ºä¹˜å®¢**
   - âœ… æ£€æŸ¥æ•°é‡é™åˆ¶ï¼ˆæœ€å¤š 20 ä¸ªï¼‰
   - âœ… éªŒè¯è¯ä»¶å·å”¯ä¸€æ€§
   - âœ… å¤„ç†é»˜è®¤ä¹˜å®¢è®¾ç½®ï¼ˆè‡ªåŠ¨å–æ¶ˆå…¶ä»–é»˜è®¤ï¼‰

2. **æ›´æ–°ä¹˜å®¢**
   - âœ… éªŒè¯æ‰€å±æƒï¼ˆåªèƒ½ä¿®æ”¹è‡ªå·±çš„ä¹˜å®¢ï¼‰
   - âœ… æ”¯æŒéƒ¨åˆ†å­—æ®µæ›´æ–°
   - âœ… è¯ä»¶å·æ›´æ–°æ—¶æ£€æŸ¥é‡å¤

3. **åˆ é™¤ä¹˜å®¢**
   - âœ… éªŒè¯æ‰€å±æƒ
   - âœ… çº§è”åˆ é™¤ï¼ˆorder_items çš„å¼•ç”¨ä¼šè‡ªåŠ¨æ¸…ç©ºï¼‰

---

### 3.4 PassengerController.java - æ§åˆ¶å™¨

**ä½ç½®ï¼š** `controller/PassengerController.java`

**API ç«¯ç‚¹ï¼š**

| HTTPæ–¹æ³• | è·¯å¾„ | åŠŸèƒ½ | è¯´æ˜ |
|----------|------|------|------|
| GET | `/api/passengers` | è·å–ä¹˜å®¢åˆ—è¡¨ | è¿”å›å½“å‰ç”¨æˆ·æ‰€æœ‰ä¹˜å®¢ |
| GET | `/api/passengers/{id}` | è·å–ä¹˜å®¢è¯¦æƒ… | éªŒè¯æ‰€å±æƒ |
| POST | `/api/passengers` | åˆ›å»ºä¹˜å®¢ | éœ€è¦ç™»å½• |
| PUT | `/api/passengers/{id}` | æ›´æ–°ä¹˜å®¢ | éœ€è¦ç™»å½• |
| PATCH | `/api/passengers/{id}/default` | è®¾ç½®é»˜è®¤ä¹˜å®¢ | éœ€è¦ç™»å½• |
| DELETE | `/api/passengers/{id}` | åˆ é™¤ä¹˜å®¢ | éœ€è¦ç™»å½• |

**å“åº”æ ¼å¼ï¼š**
```json
{
  "success": true,
  "message": "æ“ä½œæˆåŠŸ",
  "data": { ... }
}
```

---

## âš™ï¸ å››ã€é…ç½®è¦æ±‚

### 4.1 å¯ç”¨ JPA å®¡è®¡ï¼ˆå¿…é¡»ï¼‰

åœ¨ä½ çš„ä¸»é…ç½®ç±»æˆ–ä¸“é—¨çš„ JPA é…ç½®ç±»ä¸­æ·»åŠ ï¼š

**æ–‡ä»¶ï¼š** `src/main/java/com/seu/airline/config/JpaConfig.java`

```java
package com.seu.airline.config;

import org.springframework.context.annotation.Configuration;
import org.springframework.data.jpa.repository.config.EnableJpaAuditing;

@Configuration
@EnableJpaAuditing  // â† å¯ç”¨ JPA å®¡è®¡ï¼Œæ”¯æŒ @CreatedDate å’Œ @LastModifiedDate
public class JpaConfig {
}
```

### 4.2 Spring Security é…ç½®

ç¡®è®¤ `WebSecurityConfig.java` ä¸­ `/api/passengers/**` éœ€è¦ç™»å½•ï¼š

```java
.antMatchers("/api/passengers/**").authenticated()  // éœ€è¦ç™»å½•
```

---

## ğŸ” äº”ã€æ•°æ®éªŒè¯è§„åˆ™

### 5.1 åˆ›å»ºä¹˜å®¢ï¼ˆPassengerCreateRequestï¼‰

| å­—æ®µ | éªŒè¯è§„åˆ™ | é”™è¯¯æç¤º |
|------|----------|----------|
| `passengerName` | å¿…å¡«ï¼Œ2-100 å­—ç¬¦ | "ä¹˜å®¢å§“åä¸èƒ½ä¸ºç©º" |
| `idType` | å¿…å¡«ï¼Œæšä¸¾å€¼ | "è¯ä»¶ç±»å‹å¿…é¡»æ˜¯ID_CARDã€PASSPORTæˆ–OTHER" |
| `idCard` | å¿…å¡«ï¼Œæœ€å¤š 50 å­—ç¬¦ | "è¯ä»¶å·ç ä¸èƒ½ä¸ºç©º" |
| `phone` | å¯é€‰ï¼Œæ‰‹æœºå·æ ¼å¼ | "æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®" |
| `email` | å¯é€‰ï¼Œé‚®ç®±æ ¼å¼ | "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®" |
| `passengerType` | å¿…å¡«ï¼Œæšä¸¾å€¼ | "ä¹˜å®¢ç±»å‹å¿…é¡»æ˜¯ADULTã€CHILDæˆ–INFANT" |

### 5.2 æ›´æ–°ä¹˜å®¢ï¼ˆPassengerUpdateRequestï¼‰

- æ‰€æœ‰å­—æ®µéƒ½æ˜¯å¯é€‰çš„
- åªæ›´æ–°æä¾›çš„å­—æ®µ
- éªŒè¯è§„åˆ™ä¸åˆ›å»ºæ—¶ç›¸åŒ

---

## ğŸš€ å…­ã€æµ‹è¯•æ­¥éª¤

### 6.1 å¯åŠ¨åç«¯æœåŠ¡

```powershell
# å¯¼èˆªåˆ°åç«¯é¡¹ç›®æ ¹ç›®å½•
cd "d:\University\Grade4-1\Lessons\è½¯ä»¶å¼€å‘ç»¼åˆè¯¾ç¨‹è®¾è®¡\SEUAirline\seu-airline-backend"

# å¯åŠ¨åç«¯ï¼ˆMavenï¼‰
mvn spring-boot:run
```

### 6.2 è®¿é—® Swagger UI

æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š

```
http://localhost:8080/swagger-ui.html
```

åœ¨ Swagger UI ä¸­æ‰¾åˆ° **"ä¹˜å®¢ä¿¡æ¯ç®¡ç†"** åˆ†ç»„ã€‚

### 6.3 æµ‹è¯•æµç¨‹

#### Step 1: ç”¨æˆ·ç™»å½•

1. è°ƒç”¨ `/api/auth/signin` ç™»å½•
2. å¤åˆ¶è¿”å›çš„ `accessToken`
3. åœ¨ Swagger å³ä¸Šè§’ç‚¹å‡» "Authorize"ï¼Œè¾“å…¥ `Bearer <token>`

#### Step 2: åˆ›å»ºä¹˜å®¢

```json
POST /api/passengers
{
  "passengerName": "å¼ ä¸‰",
  "idType": "ID_CARD",
  "idCard": "320106199001011234",
  "phone": "13800138000",
  "email": "zhangsan@example.com",
  "passengerType": "ADULT",
  "isDefault": true
}
```

#### Step 3: æŸ¥è¯¢ä¹˜å®¢åˆ—è¡¨

```http
GET /api/passengers
```

#### Step 4: æ›´æ–°ä¹˜å®¢

```json
PUT /api/passengers/1
{
  "phone": "13900139000",
  "email": "newemail@example.com"
}
```

#### Step 5: è®¾ç½®é»˜è®¤ä¹˜å®¢

```http
PATCH /api/passengers/2/default
```

#### Step 6: åˆ é™¤ä¹˜å®¢

```http
DELETE /api/passengers/3
```

---

## ğŸ› ä¸ƒã€å¸¸è§é—®é¢˜

### 7.1 ç¼–è¯‘é”™è¯¯

**é—®é¢˜ï¼š** `@CreatedDate` å’Œ `@LastModifiedDate` ä¸ç”Ÿæ•ˆ

**è§£å†³æ–¹æ¡ˆï¼š**
1. ç¡®è®¤æ·»åŠ äº† `@EnableJpaAuditing` æ³¨è§£
2. é‡å¯åç«¯æœåŠ¡

---

### 7.2 éªŒè¯å¤±è´¥

**é—®é¢˜ï¼š** æ‰‹æœºå·æˆ–é‚®ç®±æ ¼å¼éªŒè¯å¤±è´¥

**è§£å†³æ–¹æ¡ˆï¼š**
- æ‰‹æœºå·å¿…é¡»æ˜¯ 11 ä½ï¼Œä»¥ 1 å¼€å¤´ï¼Œç¬¬äºŒä½æ˜¯ 3-9
- é‚®ç®±å¿…é¡»åŒ…å« `@` ç¬¦å·

---

### 7.3 æƒé™é”™è¯¯

**é—®é¢˜ï¼š** 401 Unauthorized

**è§£å†³æ–¹æ¡ˆï¼š**
1. ç¡®è®¤å·²ç™»å½•å¹¶è·å– token
2. åœ¨ Swagger ä¸­ç‚¹å‡» "Authorize" è¾“å…¥ `Bearer <token>`
3. æ£€æŸ¥ token æ˜¯å¦è¿‡æœŸ

---

### 7.4 æ•°æ®åº“å¤–é”®çº¦æŸé”™è¯¯

**é—®é¢˜ï¼š** Cannot add or update a child row: a foreign key constraint fails

**è§£å†³æ–¹æ¡ˆï¼š**
- ç¡®è®¤ `user_id` å¯¹åº”çš„ç”¨æˆ·å­˜åœ¨äº `users` è¡¨ä¸­
- ä½¿ç”¨æµ‹è¯•è´¦å· `passenger1` / `password` æˆ– `passenger2` / `password`

---

## ğŸ“Š å…«ã€æ•°æ®åº“éªŒè¯æŸ¥è¯¢

### 8.1 æŸ¥çœ‹æ‰€æœ‰ä¹˜å®¢

```sql
SELECT * FROM passengers;
```

### 8.2 æŸ¥çœ‹æŸä¸ªç”¨æˆ·çš„ä¹˜å®¢

```sql
SELECT * FROM passengers WHERE user_id = 3;
```

### 8.3 æŸ¥çœ‹é»˜è®¤ä¹˜å®¢

```sql
SELECT * FROM passengers WHERE is_default = TRUE;
```

### 8.4 ç»Ÿè®¡æ¯ä¸ªç”¨æˆ·çš„ä¹˜å®¢æ•°é‡

```sql
SELECT user_id, COUNT(*) as passenger_count 
FROM passengers 
GROUP BY user_id;
```

---

## ğŸ¯ ä¹ã€åç»­é›†æˆä»»åŠ¡

### 9.1 è®¢å•ç³»ç»Ÿé›†æˆ

åœ¨åˆ›å»ºè®¢å•æ—¶ï¼Œéœ€è¦ä¿®æ”¹ `OrderItem` å®ä½“ï¼Œæ·»åŠ ä¹˜å®¢å¼•ç”¨ï¼š

```java
@ManyToOne(fetch = FetchType.LAZY)
@JoinColumn(name = "passenger_id")
private Passenger passenger;
```

### 9.2 å‰ç«¯é›†æˆ

å‚è€ƒæ–‡æ¡£ï¼š

- `seu-airline-vue/docs/å¸¸ç”¨ä¹˜å®¢åŠŸèƒ½-å‰ç«¯é›†æˆæŒ‡å—.md`

å‰ç«¯å·²ç»å®ç°ï¼š

- `src/types/passenger.ts` - ç±»å‹å®šä¹‰å’Œè½¬æ¢å‡½æ•°
- `src/api/passenger.ts` - API è°ƒç”¨å°è£…
- `src/stores/passenger.ts` - çŠ¶æ€ç®¡ç†

---

## âœ… åã€æ£€æŸ¥æ¸…å•

åœ¨å®Œæˆå®ç°åï¼Œè¯·æ£€æŸ¥ä»¥ä¸‹é¡¹ï¼š

- [ ] æ•°æ®åº“è„šæœ¬ `init-database.sql` å·²æ‰§è¡Œï¼ˆåŒ…å« passengers è¡¨ï¼‰
- [ ] è¡¨ `passengers` å·²åˆ›å»ºæˆåŠŸ
- [ ] å·²æœ‰æµ‹è¯•ä¹˜å®¢æ•°æ®ï¼ˆpassenger1 å’Œ passenger2 å„æœ‰å¸¸ç”¨ä¹˜å®¢ï¼‰
- [ ] æ‰€æœ‰ Java ç±»å·²åˆ›å»ºï¼ˆEntity, Repository, Service, Controller, DTOsï¼‰
- [ ] JPA å®¡è®¡å·²å¯ç”¨ï¼ˆ`@EnableJpaAuditing` åœ¨ JpaConfig.java ä¸­ï¼‰
- [ ] åç«¯æœåŠ¡å¯ä»¥æ­£å¸¸å¯åŠ¨
- [ ] Swagger UI å¯ä»¥çœ‹åˆ° "ä¹˜å®¢ä¿¡æ¯ç®¡ç†" API
- [ ] æµ‹è¯•è´¦å·å¯ä»¥æˆåŠŸç™»å½•å¹¶è°ƒç”¨ APIï¼ˆä½¿ç”¨ passenger1/password æˆ– passenger2/passwordï¼‰
- [ ] åˆ›å»ºã€æŸ¥è¯¢ã€æ›´æ–°ã€åˆ é™¤åŠŸèƒ½éƒ½èƒ½æ­£å¸¸å·¥ä½œ
- [ ] æ•°æ®éªŒè¯è§„åˆ™ç”Ÿæ•ˆï¼ˆæ‰‹æœºå·ã€é‚®ç®±æ ¼å¼ç­‰ï¼‰
- [ ] é»˜è®¤ä¹˜å®¢è®¾ç½®åŠŸèƒ½æ­£å¸¸
- [ ] å‰ç«¯å¯ä»¥æˆåŠŸè°ƒç”¨åç«¯ API

---

## ğŸ“š åä¸€ã€ç›¸å…³æ–‡æ¡£

1. **æ•°æ®åº“è®¾è®¡**
   - `seu-airline-backend/src/main/resources/init-database.sql`

2. **å‰ç«¯é›†æˆ**
   - `seu-airline-vue/docs/ä¹˜å®¢ä¿¡æ¯ç®¡ç†-å‰ç«¯å¼€å‘æ–‡æ¡£.md`

---

## ğŸ‰ å¿«é€Ÿå¼€å§‹

å¯¹äºå…¶ä»–åŒå­¦é…ç½®æœ¬åŠŸèƒ½ï¼Œåªéœ€è¦ï¼š

1. **æ‰§è¡Œæ•°æ®åº“åˆå§‹åŒ–**
   ```powershell
   cd seu-airline-backend/src/main/resources
   Get-Content init-database.sql | mysql -u root -p seu_airline
   ```

2. **å¯åŠ¨åç«¯æœåŠ¡**
   ```powershell
   cd seu-airline-backend
   mvn spring-boot:run
   ```

3. **è®¿é—® Swagger æµ‹è¯•**
   ```text
   http://localhost:8080/swagger-ui.html
   ```
   æŸ¥æ‰¾ "ä¹˜å®¢ä¿¡æ¯ç®¡ç†" åˆ†ç»„ï¼Œä½¿ç”¨ `passenger1` / `password` ç™»å½•æµ‹è¯•ã€‚

---

**æœ€åæ›´æ–°æ—¶é—´ï¼š** 2025å¹´11æœˆ12æ—¥
